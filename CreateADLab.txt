##################################
# Create AD Lab using Parallels  #
##################################

# https://blogs.technet.microsoft.com/pie/2017/06/30/credential-theft-made-easy-with-kerberos-delegation/
# https://www.risual.com/2014/07/10/cannot-find-active-directory-users-and-computers-on-server-2012-and-r2/
# https://mivilisnet.wordpress.com/2017/06/29/changing-sid-of-cloned-vms/
# https://hackernoon.com/kerberoasting-u
# https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/ps-remoting-second-hop?view=powershell-6
# http://thehackerplaybook.com/Windows_Domain.htm
# https://social.technet.microsoft.com/wiki/contents/articles/20260.how-to-join-windows-server-2012-to-a-domain.aspx
# https://blogs.msdn.microsoft.com/canberrapfe/2012/01/01/kerberos-troubleshooting/

# Download Windows Server 2012 R2 from Microsoft
https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2012-r2

# Workstations
https://developer.microsoft.com/en-us/windows/downloads/virtual-machines
https://www.microsoft.com/en-us/software-download/windows8ISO
https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/

# *NIX
https://ubuntu.com/download/server

# Create default VM Windows Server 2012 R2 as base

##################################
# Cloned VM                      #
##################################

# After Cloning the base W12 Server, start the cloned VM
## Run sysprep
# Open sysprep in explorer located at C:\Windows\System32\sysprep
# Right-click and Run as Administrator
# Leave everything to default
# Be sure to check the box for Generalize
# Click on Ok

# Reboot

##################################
# ADWS | DNS | KDC | NetLogon    #
##################################
## Set Static IP and Hostname
# Disable Firewall(s)
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

# Setup Static IP
New-NetIPAddress –IPAddress 10.211.55.16 -DefaultGateway 10.211.55.1 -PrefixLength 8 -InterfaceIndex (Get-NetAdapter).InterfaceIndex

# Set Computer Name
$hostname = "W12SrvrAD"
Rename-Computer $hostname

# Reboot

## Set local Administrator PWD

# Give the local Administrator account a password
net user Administrator P@ssw0rd2013
net user Administrator /passwordreq:yes

# Reboot

# Setup AD

Add-WindowsFeature AD-Domain-Services
Add-windowsfeature RSAT-ADDS

Import-Module ADDSDeployment

$SafeModeAdministratorPasswordText = "P@ssw0rd2013"
$SafeModeAdministratorPassword = ConvertTo-SecureString -AsPlainText $SafeModeAdministratorPasswordText -Force

Install-ADDSForest -CreateDNSDelegation:$False -DatabasePath “c:\Windows\NTDS” -DomainMode ‘Win2012R2’ -DomainName "tst.com” -DomainNetbiosName “TSTAD” -ForestMode ‘Win2012R2’ -InstallDNS:$true -LogPath “C:\Windows\NTDS” -NoRebootOnCompletion:$false -Sysvolpath “C:\Windows\SYSVOL” -Force:$true -SafeModeAdministratorPassword $SafeModeAdministratorPassword

# Reboot

## Run DCDiag
DCDiag /c /v /e /fix /f:c:\DCDIAG.Log

# Verify Services are running
$svcs = "adws","dns","kdc","netlogon"
Get-Service -name $svcs -ComputerName $env:COMPUTERNAME

##################################
# Join to tst.com | TSTAD Domain #
##################################

## Clone VM
# Run sysprep
# Open sysprep in explorer located at C:\Windows\System32\sysprep
# Right-click and Run as Administrator
# Leave everything to default
# Check the box for Generalize
# Click on Ok

# Reboot

## Set Static IP and Hostname

# Setup Static IP
New-NetIPAddress –IPAddress 10.211.55.### -DefaultGateway 10.211.55.1 -PrefixLength 8 -InterfaceIndex (Get-NetAdapter).InterfaceIndex

# Set Computer Name
$hostname = "<Hostname>"
Rename-Computer $hostname

# Reboot

## Join Domain

# System Properties > Computer Name
# Click on Change
# Click on Member of Domain (Radio Button)
# Enter 'tst.com'
# Click Ok
# Enter Administrator and the Password used to setup AD
# Click Ok

# Reboot

## Finish, Repeat as required.

## Ubuntu Server 19.04
## To install Parallels Tool follow the direction at:
https://gist.github.com/mag911/1a5583a766467d6023584d738cee0d98

## Disable the Firewall
sudo ufw disable
sudo ufw status

## Static IP
vi /etc/netplan/##-netcfg.yaml

network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: false
      # Ser IP address & subnet mask
      addresses: [10.10.1.5/24]
      # Set default gateway
      gateway4: 10.10.1.1
      nameservers:
        # Set DNS name servers
        addresses: [10.10.1.1,8.8.8.8]
      dhcp6: no
      
sudo netplan apply
 
## Disable IPv6
echo "net.ipv6.conf.all.disable_ipv6 = 1" | sudo tee -a /etc/sysctl.conf

##################################
# WinRMRemoteWMIUsers__ group    #
##################################

# Create a user i.e., tstusr in AD
# Add tstusr into WinRMRemoteWMIUsers__ group and to the Local Administator group on each Windows box

## Enable PowerShell Remoting

# As Administrator
Enable-PSRemoting –force

# Set start mode to automatic
Set-Service WinRM -StartMode Automatic

# Verify start mode and state - it should be running
Get-WmiObject -Class win32_service | Where-Object {$_.name -like "WinRM"}

# Trust all hosts
Set-Item WSMan:localhost\client\trustedhosts -value *

# Verify trusted hosts configuration
Get-Item WSMan:\localhost\Client\TrustedHosts

# Enabling Basic Authentication
Set-Item WSMan:\localhost\Service\AllowUnencrypted $true 

winrm set winrm/config/client/auth @{Basic="true"}
winrm set winrm/config/service/auth @{Basic="true"}
winrm set winrm/config/service @{AllowUnencrypted="true"}

## KDC Claims
https://syfuhs.net/2017/07/29/active-directory-claims-and-kerberos-net/
https://www.varonis.com/blog/kerberos-authentication-explained/
https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/ad-fs-compound-authentication-and-ad-ds-claims

# View
[Security.Principal.WindowsIdentity]::GetCurrent()
[System.Security.Principal.WindowsIdentity]::getcurrent().claims | fl type, value
